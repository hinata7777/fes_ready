<div class="min-h-screen px-4 pb-24 pt-6">
  <div class="mx-auto flex max-w-6xl flex-col gap-6">
    <%= render "shared/timetable_header",
               title: "マイタイムテーブル作成",
               festival_name: @festival.name,
               selected_day: @selected_day,
               timezone: @timezone do %>
      <p class="mt-4 text-sm text-slate-700">
        見たいアーティストのブロックをタップして選択してください。選択した内容は「保存する」を押すとマイタイムテーブルに反映されます。
      </p>
    <% end %>

    <%= form_with url: my_timetable_festival_path(@festival, date: @selected_day.date.to_s, user_id: current_user.uuid),
                  method: :post,
                  class: "flex flex-col gap-6" do %>
      <% stage_renderer = ->(stage) do
           render "stage_column_picker",
                  stage: stage,
                  performances: @performances_by_stage[stage.id],
                  time_markers: @time_markers,
                  timeline_layout: @timeline_layout,
                  picked_ids: @picked_ids
         end %>

      <%= render "shared/timetable_board",
                 stages: @stages,
                 time_markers: @time_markers,
                 timeline_layout: @timeline_layout,
                 timezone: @timezone,
                 empty_message: "登録されたステージがありません",
                 stage_renderer: stage_renderer %>

      <% if @performances_without_stage.present? %>
        <section class="rounded-3xl border border-dashed border-slate-300 bg-white/80 p-4 shadow-sm">
          <h2 class="text-sm font-bold text-slate-700">ステージ未設定の出演</h2>
          <p class="mt-2 text-xs text-slate-500">以下の出演はステージが未設定のため、リスト形式で選択できます。</p>
          <div class="mt-4 space-y-3">
            <% @performances_without_stage.each do |performance| %>
              <% checkbox_id = "stage-performance-#{performance.id}" %>
              <div class="rounded-2xl border border-slate-200 bg-white p-3 shadow-sm">
                <%= check_box_tag "stage_performance_ids[]",
                                   performance.id,
                                   @picked_ids.include?(performance.id),
                                   id: checkbox_id,
                                   class: "peer sr-only" %>
                <label for="<%= checkbox_id %>"
                       class="block w-full rounded-xl border border-transparent px-3 py-2 transition interactive-lift peer-checked:border-rose-500 peer-checked:bg-rose-50 peer-checked:shadow-md"
                       data-controller="tap-feedback">
                  <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                      <div class="text-sm font-semibold text-slate-800">
                        <%= performance.artist.name %>
                      </div>
                      <div class="text-xs font-mono text-slate-500">
                        <%= performance.starts_at&.in_time_zone(@timezone)&.strftime("%H:%M") %> - <%= performance.ends_at&.in_time_zone(@timezone)&.strftime("%H:%M") %>
                      </div>
                    </div>
                    <span class="mt-1 inline-flex items-center rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 transition peer-checked:border-rose-500 peer-checked:bg-rose-500 peer-checked:text-white sm:mt-0">
                      <span class="hidden peer-checked:inline">選択中</span>
                    </span>
                  </div>
                </label>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

      <div class="flex justify-center">
        <%= submit_tag "保存する",
                       class: "inline-flex items-center justify-center rounded-2xl bg-indigo-500 px-6 py-3 text-sm font-bold text-white shadow-md interactive-lift hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" %>
      </div>
    <% end %>
  </div>
</div>
