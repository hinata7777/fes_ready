<% hex = stage.color_hex %>
<% text_color = stage_text_color(hex) %>
<% total_seconds ||= ((timeline_end - timeline_start) / 1.second).to_i %>
<% total_seconds = [total_seconds, 3600].max %>
<% hour_height_px = 90 %>
<% column_height ||= [total_seconds / 3600.0 * hour_height_px, hour_height_px].max %>

<div class="flex h-full min-w-[90px] flex-1 flex-col rounded-xl bg-white shadow-sm sm:min-w-[150px]">
  <div class="flex h-10 items-center justify-center rounded-t-xl px-2 text-center text-[11px] font-semibold uppercase tracking-wide sm:h-12 sm:px-3 sm:text-xs"
       style="background-color: <%= hex %>; color: <%= text_color %>;">
    <%= stage.name %>
  </div>
  <div class="relative overflow-hidden rounded-b-xl border border-slate-200 bg-slate-50"
       style="height: <%= column_height %>px;">
    <% time_markers.each do |marker_time| %>
      <% next if marker_time <= timeline_start %>
      <% marker_offset_seconds = ((marker_time - timeline_start) / 1.second).to_f %>
      <% offset = marker_offset_seconds / total_seconds.to_f %>
      <% next if offset.negative? || offset > 1 %>
      <div class="absolute inset-x-0 border-t border-slate-200/70" style="top: <%= offset * 100 %>%;"></div>
    <% end %>

    <div class="relative h-full w-full">
      <% Array(performances).each do |performance| %>
        <% block = timeline_performance_block(
              performance,
              timeline_start: timeline_start,
              timeline_end: timeline_end,
              timezone: timezone,
              column_height: column_height
            ) %>
        <% next unless block %>
        <% input_id = "stage-performance-#{performance.id}" %>
        <div class="absolute inset-x-1.5 sm:inset-x-2"
             style="top: <%= block.top_percent %>%; height: <%= block.height_percent %>%;">
          <%= check_box_tag "stage_performance_ids[]",
                             performance.id,
                             picked_ids.include?(performance.id),
                             id: input_id,
                             class: "peer sr-only" %>
          <span class="pointer-events-none absolute right-1 top-1 z-20 flex items-center justify-center rounded-full bg-white/95 p-[2px] opacity-0 shadow-sm transition transform scale-75 peer-checked:opacity-100 peer-checked:scale-100">
            <%= image_tag "icons/check_mark.svg",
                          alt: "",
                          width: 18,
                          height: 18,
                          class: "h-4 w-4" %>
          </span>
          <label for="<%= input_id %>"
                 class="group flex h-full w-full cursor-pointer flex-col justify-start gap-px rounded-md border border-white/50 px-1.5 py-1 text-left text-[11px] font-semibold shadow-sm transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500 peer-checked:border-white peer-checked:shadow-lg peer-checked:ring-2 peer-checked:ring-white/80 interactive-lift sm:px-2.5 sm:py-2 sm:text-xs"
                 data-controller="tap-feedback"
                 style="background-color: <%= hex %>; color: <%= text_color %>;">
            <div class="font-mono text-[9px] font-medium leading-none opacity-90 sm:text-[10px]">
              <div class="whitespace-nowrap">
                <%= block.start_label %><% if block.end_label %>-<%= block.end_label %><% end %>
              </div>
            </div>
            <div class="flex-1 overflow-hidden text-ellipsis whitespace-normal text-[11px] font-bold leading-tight sm:text-xs">
              <%= performance.artist.name %>
            </div>
            <span class="mt-auto hidden text-[10px] font-semibold uppercase tracking-wide peer-checked:inline opacity-100">選択中</span>
          </label>
        </div>
      <% end %>
    </div>
  </div>
</div>
