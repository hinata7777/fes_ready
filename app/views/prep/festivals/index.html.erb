<div class="min-h-screen px-4 py-6">
  <div class="mx-auto max-w-5xl space-y-6">
    <header class="space-y-4">
      <h1 class="text-2xl font-bold text-slate-900">フェス予習一覧</h1>
      <p class="text-sm text-slate-600">フェスごとの予習ページをまとめています。<br>参加予定のフェスから曲をチェックしましょう。</p>
      <% unless user_signed_in? %>
        <%= render "shared/login_callout",
                   title: "ログインして予習するアーティストを保存しましょう",
                   description: "お気に入り登録で、気になるフェスをすぐに見返せます。",
                   cta_label: "ログイン" %>
      <% end %>
      <% preserved_query = request.query_parameters.except(:page, :status) %>
      <div class="flex justify-center">
        <%= render "shared/segmented_tabs",
              tabs: status_labels,
              active_tab_key: @status,
              url_builder: ->(key) do
                path_options = preserved_query.merge(status: key)
                prep_festivals_path(path_options)
              end %>
      </div>
    </header>

    <% search_url = prep_festivals_path %>
    <% search_query = params.dig(:q, :name_i_cont) %>
    <% hidden_filter_fields = {
         start_date_from: @filter_params[:start_date_from],
         end_date_to: @filter_params[:end_date_to],
         area: @filter_params[:area],
         "tag_ids[]": @selected_tag_ids
       } %>
    <%= render Shared::SearchFormComponent.new(
               query: @q,
               url: search_url,
               placeholder: "フェス名を入力",
               status: @status,
               hidden_fields: hidden_filter_fields
             ) %>

    <% reset_params = { status: @status } %>
    <% reset_params[:q] = { name_i_cont: search_query } if search_query.present? %>
    <% reset_url = prep_festivals_path(reset_params) %>

    <%= render "shared/festival_filters",
               form_url: search_url,
               status: @status,
               search_query: search_query,
               filter_params: @filter_params,
               festival_tags: @festival_tags,
               selected_tag_ids: @selected_tag_ids,
               reset_url: reset_url %>

    <section class="grid gap-3 md:grid-cols-2 md:gap-4">
      <% if @festivals.any? %>
        <% @festivals.each do |festival| %>
          <div class="w-full">
            <%= render "shared/nav_stack_button",
                       label: festival.name,
                       subtext: festival_date_and_location(festival),
                       url: prep_festival_path(festival),
                       trailing: favorite_button_for(
                         favorited: festival_favorited?(festival),
                         toggle_url: festival_favorite_path(festival)
                       ) %>
          </div>
        <% end %>
      <% else %>
        <p class="rounded-xl bg-white px-4 py-12 text-center text-sm text-slate-500 shadow md:col-span-2 space-y-1">
          <span class="block">表示できるフェスがありません。</span>
          <span class="block">予習対象のフェスが見つかりませんでした。</span>
          <span class="block">開催時期やタグを変えて再検索してください。</span>
        </p>
      <% end %>
    </section>
    <%= render "shared/pagination", pagy: @pagy %>
  </div>
</div>
